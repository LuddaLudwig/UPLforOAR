<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Bayesian UPL • UPLforOAR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Bayesian UPL">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">UPLforOAR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Bayesian-UPL.html">Bayesian UPL</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/USEPA/UPLforOAR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Bayesian UPL</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/USEPA/UPLforOAR/blob/main/vignettes/Bayesian-UPL.Rmd" class="external-link"><code>vignettes/Bayesian-UPL.Rmd</code></a></small>
      <div class="d-none name"><code>Bayesian-UPL.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette describes the use of the <code><a href="../reference/Bayesian_UPL.html">Bayesian_UPL()</a></code>
function. The goal of <code><a href="../reference/Bayesian_UPL.html">Bayesian_UPL()</a></code> is to provide a
flexible and consistent method of calculating Upper Predictive Limits
(UPL) for any type of emissions data to determine National Emissions
Standards for Hazardous Air Pollutants (NESHAP) for existing and new
sources.</p>
<p>Current UPL methods are only applicable to emissions data that are
distributed Normally, Skewed, or Lognormally. The UPL for Normal data
can be calculated analytically with <code><a href="../reference/Normal_UPL.html">Normal_UPL()</a></code> using the
mean, standard deviation, and t-score. However, there are no equivalent
analytical solutions for Skewed or Lognormal UPL calculations. Instead,
<code><a href="../reference/Lognormal_UPL.html">Lognormal_UPL()</a></code> uses a Gram-Charlier Type A Series
expansion to approximate the density distribution and determine the
arithmetic mean of future samples, and <code><a href="../reference/Skewed_UPL.html">Skewed_UPL()</a></code> uses
the skewness and kurtosis moments to iteratively adjust the t-score
until the desired significance is achieved. All three UPL methods assume
the distribution explicitly and without uncertainty, and assume the
emissions are observed perfectly and independently.</p>
<p>By operating in a Bayesian framework, we can use the same method of
deriving the UPL while agnostic to the type of distribution, but also
dramatically increase the choices for the distribution. Bayesian
inference also benefits from fewer assumptions and better uncertainty
quantification. This allows for more accurate representation of
emissions data and better transparency and metrics of fitness to support
the UPL calculation.</p>
<p>The <code><a href="../reference/Bayesian_UPL.html">Bayesian_UPL()</a></code> uses a Monte Carlo Markov Chain
(MCMC) sampler (a Gibbs sampler implemented via JAGS) to fit probability
distributions to emissions data. For example, when using a Normal
distribution, this entails estimating the mean and standard deviation
which define the distribution. Unlike the <code><a href="../reference/Normal_UPL.html">Normal_UPL()</a></code>
analytical solution, we don’t merely get a point-estimate of the mean
and standard deviation, but instead derive a posterior distribution that
describes the full probability for the mean and standard deviation. This
allows us to quantify the uncertainty in the predicted probability
distribution for any future emission observation.</p>
<p>Numerous probability distributions are already implemented in R
<code>stats</code> and JAGS, and any distribution that isn’t, or any
combination of distributions, can be coded manually in JAGS if needed.
For any probability distribution, the UPL is calculated by taking the
99^{th} percentile of the average of new draws (usually 3 new runs to be
comparative to a typical compliance test).</p>
</div>
<div class="section level2">
<h2 id="example-hcl-emissions-from-integrated-iron-and-steel">Example: HCl Emissions from Integrated Iron and Steel<a class="anchor" aria-label="anchor" href="#example-hcl-emissions-from-integrated-iron-and-steel"></a>
</h2>
<div class="section level3">
<h3 id="step-1-load-and-plot-the-emissions-observations">Step 1: Load and plot the emissions observations<a class="anchor" aria-label="anchor" href="#step-1-load-and-plot-the-emissions-observations"></a>
</h3>
<p>Let’s look at an example data set of HCl emissions from Integrated
Iron and Steel. This data set as provided is already the set of top
performers in the industry, so there is no need to run
<code><a href="../reference/MACT_EG.html">MACT_EG()</a></code> to select the data. The first step is to load and
plot the emissions data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_emiss</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">'IIS_HCl.csv'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">emission_mean</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dat_emiss</span><span class="op">$</span><span class="va">emissions</span><span class="op">)</span></span>
<span><span class="va">dat_means</span><span class="op">=</span><span class="fu">summarize</span><span class="op">(</span><span class="va">dat_emiss</span>,means<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">emissions</span><span class="op">)</span>,counts<span class="op">=</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>,.by<span class="op">=</span><span class="st">'sources'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat_means</span><span class="op">$</span><span class="va">sources</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">dat_means</span><span class="op">$</span><span class="va">sources</span><span class="op">)</span></span>
<span><span class="va">dat_means</span><span class="op">$</span><span class="va">sources</span><span class="op">=</span><span class="fu">fct_reorder</span><span class="op">(</span><span class="va">dat_means</span><span class="op">$</span><span class="va">sources</span>,</span>
<span>                              <span class="va">dat_means</span><span class="op">$</span><span class="va">means</span>,.desc <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">dat_emiss</span><span class="op">$</span><span class="va">sources</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">dat_emiss</span><span class="op">$</span><span class="va">sources</span>,levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">dat_means</span><span class="op">$</span><span class="va">sources</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dat_means</span><span class="op">=</span><span class="fu">arrange</span><span class="op">(</span><span class="va">dat_means</span>,<span class="va">means</span><span class="op">)</span></span></code></pre></div>
<p>Take a quick look at the average emission for each source in the data
set:</p>
<table class="table">
<caption>Top sources for existing source calculation</caption>
<colgroup>
<col width="60%">
<col width="22%">
<col width="17%">
</colgroup>
<thead><tr class="header">
<th align="left">Source</th>
<th align="right">Average emission</th>
<th align="right">No. of Tests</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">CC-BurnsHarbor-IN_BF C Stove Stack</td>
<td align="right">0.000603</td>
<td align="right">12</td>
</tr>
<tr class="even">
<td align="left">USS-Braddock-PA_Blast Furnace #3 Stove Stack</td>
<td align="right">0.000805</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">USS-Braddock-PA_Blast Furnace #1 Stove Stack</td>
<td align="right">0.001240</td>
<td align="right">18</td>
</tr>
<tr class="even">
<td align="left">CC-IndianaHarbor-IN_IH7 Stove Stack</td>
<td align="right">0.003050</td>
<td align="right">3</td>
</tr>
</tbody>
</table>
<p>Next we want to look at density plots of the emission observations.
Our goal is to fit a probability density that best describes the data,
from which we can determine the UPL. In order to know the probability
density is a good match for our emissions data, we want to look at the
empirical density of the observations. For this example we will plot the
density using <code><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">ggplot2::geom_density()</a></code> by
<code>source</code> with a lower bound of 0 since negative emissions are
impossible. The <code>UPLforOAR</code> package includes several
<code>ggplot2</code> themes designed for density figures. The figure
below uses <code><a href="../reference/multi_source_theme.html">multi_source_theme()</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">emissions</span>,fill<span class="op">=</span><span class="va">sources</span><span class="op">)</span>,data<span class="op">=</span><span class="va">dat_emiss</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_density</span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0.5</span>,trim<span class="op">=</span><span class="cn">FALSE</span>,bounds<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="cn">Inf</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/multi_source_theme.html">multi_source_theme</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu">theme</span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill<span class="op">=</span><span class="fu">guide_legend</span><span class="op">(</span>nrow<span class="op">=</span><span class="fl">2</span>,byrow<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         color<span class="op">=</span><span class="fu">guide_legend</span><span class="op">(</span>nrow<span class="op">=</span><span class="fl">2</span>,byrow<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>expand<span class="op">=</span><span class="fu">expansion</span><span class="op">(</span>mult<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.05</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>expand<span class="op">=</span><span class="fu">expansion</span><span class="op">(</span>mult<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.05</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_rug</span><span class="op">(</span>sides<span class="op">=</span><span class="st">'b'</span>,<span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">emissions</span>,color<span class="op">=</span><span class="va">sources</span><span class="op">)</span>,</span>
<span>           alpha<span class="op">=</span><span class="fl">0.5</span>,outside<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">+</span><span class="fu">coord_cartesian</span><span class="op">(</span>clip<span class="op">=</span><span class="st">'off'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Source observed populations"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Density"</span><span class="op">)</span><span class="op">+</span><span class="fu">xlab</span><span class="op">(</span><span class="st">"IIS HCl emissions"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>fill<span class="op">=</span><span class="st">'Top sources'</span>,color<span class="op">=</span><span class="st">'Top sources'</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="Bayesian-UPL_files/figure-html/figure1-1.png" alt="Observation density of IIS HCl emissions by top performing source." width="528"><p class="caption">
Observation density of IIS HCl emissions by top performing source.
</p>
</div>
<p>For most cases however, we will want more control over the density
results. The default settings in <code><a href="../reference/obs_density.html">obs_density()</a></code> are designed
to be compatible with typical emissions data, such as appropriate kernel
types, bandwidths, bounds, and estimators, for non-zero data, as well as
a better default bandwidth estimator. Furthermore, we can store the
results directly in our environment rather than them being inside the
<code>ggplot</code> object.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs_dens_results</span><span class="op">=</span><span class="fu"><a href="../reference/obs_density.html">obs_density</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">dat_emiss</span><span class="op">)</span></span>
<span><span class="va">Obs_onPoint</span><span class="op">=</span><span class="va">obs_dens_results</span><span class="op">$</span><span class="va">Obs_onPoint</span></span>
<span><span class="va">obs_den_df</span><span class="op">=</span><span class="va">obs_dens_results</span><span class="op">$</span><span class="va">obs_den_df</span></span></code></pre></div>
<p>The figure below shows the overall observation density of the top
performing source population, of which it is our goal to determine an
appropriately representative likelihood distribution from which to
calculate the UPL. This figures uses <code><a href="../reference/pop_distr_theme.html">pop_distr_theme()</a></code> and
plots the <code><a href="../reference/obs_density.html">obs_density()</a></code> results above using
<code><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">ggplot2::geom_line</a></code> and <code><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">ggplot2::geom_line</a></code>. The
emission observations themselves are indicated as points and as a rug
underneath the plot.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu">ggplot</span><span class="op">(</span>data<span class="op">=</span><span class="va">Obs_onPoint</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">obs_den_df</span>,<span class="fu">aes</span><span class="op">(</span>y<span class="op">=</span><span class="va">ydens</span>,x<span class="op">=</span><span class="op">(</span><span class="va">x_hat</span><span class="op">)</span><span class="op">)</span>,size<span class="op">=</span><span class="fl">0.75</span>,color<span class="op">=</span><span class="st">'black'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_area</span><span class="op">(</span>data<span class="op">=</span><span class="va">obs_den_df</span>,<span class="fu">aes</span><span class="op">(</span>y<span class="op">=</span><span class="va">ydens</span>,x<span class="op">=</span><span class="op">(</span><span class="va">x_hat</span><span class="op">)</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.25</span>,fill<span class="op">=</span><span class="st">'black'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y<span class="op">=</span><span class="va">ydens</span>,x<span class="op">=</span><span class="op">(</span><span class="va">emissions</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             size<span class="op">=</span><span class="fl">3</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,shape<span class="op">=</span><span class="fl">19</span>,color<span class="op">=</span><span class="st">'black'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Density"</span><span class="op">)</span><span class="op">+</span><span class="fu">xlab</span><span class="op">(</span><span class="st">"IIS HCl emissions"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Overall observed population"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/pop_distr_theme.html">pop_distr_theme</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>expand<span class="op">=</span><span class="fu">expansion</span><span class="op">(</span>mult<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.05</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>expand<span class="op">=</span><span class="fu">expansion</span><span class="op">(</span>mult<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.05</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>clip<span class="op">=</span><span class="st">'off'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_rug</span><span class="op">(</span>sides<span class="op">=</span><span class="st">'b'</span>,<span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="op">(</span><span class="va">emissions</span><span class="op">)</span><span class="op">)</span>,data<span class="op">=</span><span class="va">dat_emiss</span>,</span>
<span>           alpha<span class="op">=</span><span class="fl">0.5</span>,outside<span class="op">=</span><span class="cn">TRUE</span>,color<span class="op">=</span><span class="st">'black'</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="Bayesian-UPL_files/figure-html/figure2-1.png" alt="Observation density of IIS HCl emissions top performers overall population." width="480"><p class="caption">
Observation density of IIS HCl emissions top performers overall
population.
</p>
</div>
</div>
<div class="section level3">
<h3 id="step-2-explore-possible-likelihood-distributions">Step 2: Explore possible likelihood distributions<a class="anchor" aria-label="anchor" href="#step-2-explore-possible-likelihood-distributions"></a>
</h3>
<p>You can use an informed decision about which likelihood distributions
to investigate. For example, a Beta distribution is only appropriate if
the observations are strictly between 0 and 1. In this case, you might
see that a Normal distribution is a poor choice given asymmetric shape
of the observations clustered above 0. However, for the purposes of the
vignette, we will look at all distributions currently supported.</p>
<p>We will fit likelihood models for the following distributions: Beta,
Gamma, Lognormal, Normal, and Skewed. Using the default settings of
<code><a href="../reference/Bayesian_UPL.html">Bayesian_UPL()</a></code> the only other information we need to
provide is the data set with <code>emissions</code>. The
<code><a href="../reference/Bayesian_UPL.html">Bayesian_UPL()</a></code> function will fit the likelihood
distributions using uninformative priors with a wide range of initial
values, test for convergence, test for goodness of fit, organize the
MCMC results for later plotting, and return the UPL for a given
significance and number of future runs. Many of these options can be
adjusted manually or evaluated step-wise, but
<code><a href="../reference/Bayesian_UPL.html">Bayesian_UPL()</a></code> is designed to run with minimal user input
needed.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">distributions</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Beta'</span>,<span class="st">'Gamma'</span>,<span class="st">'Lognormal'</span>,<span class="st">'Normal'</span>,<span class="st">'Skewed'</span><span class="op">)</span></span>
<span><span class="va">results</span><span class="op">=</span><span class="fu"><a href="../reference/Bayesian_UPL.html">Bayesian_UPL</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">dat_emiss</span>, distr_list<span class="op">=</span><span class="va">distributions</span><span class="op">)</span></span></code></pre></div>
First, let’s look at plots of the resulting distributions. The points
and error bars on these figures represent the median and 95% confidence
interval around the predicted probability for each emission observation,
using the associated likelihood distribution. The colored probability
curves indicate the predicted likelihood across a range of expected
emissions, which by default is
<code>seq(0,3*max(data$emissions,length.out=1024))</code>, but can be
changed by supplying the <code>xvals</code> argument to
<code><a href="../reference/Bayesian_UPL.html">Bayesian_UPL()</a></code>. The results for plotting the densities at
observations including error bars are stored in
<code>results$obs_pdf_dat</code>, and those for plotting the densities
along the range of <code>xvals</code> are stored in
<code>results$pred_pdf_dat</code>.
<div class="figure" style="text-align: center">
<img src="Bayesian-UPL_files/figure-html/figure3-1.png" alt="Fitted likelihood distributions for IIS HCl emissions." width="100%"><p class="caption">
Fitted likelihood distributions for IIS HCl emissions.
</p>
</div>
</div>
<div class="section level3">
<h3 id="step-3-selecting-a-distribution">Step 3: Selecting a distribution<a class="anchor" aria-label="anchor" href="#step-3-selecting-a-distribution"></a>
</h3>
<p>Unsurprisingly, the Normal distribution does not look good. All of
the other distributions are fairly similar to the observation density.
How do we pick the best distribution if there are several that seem
appropriate?</p>
<p>In some cases you can rule out options visually. For example, while
the Skewed distribution fits the probabilities at the emission
observations decently well, it has undesirable behavior near 0
emissions. Of all the distributions, the Skewed comes down to 0
probability most abruptly as emissions decline towards 0. Does this seem
like realistic behavior? It is more likely that the tiny gap between 0
and the lowest emission measurement is due to testing detection limits,
not a true 0 probability that emissions could occur that low.</p>
<p>We can also use quantitative metrics to decide on the best
distribution. All of these metrics can be accessed in
<code>fit_table</code> in the <code><a href="../reference/Bayesian_UPL.html">Bayesian_UPL()</a></code> results. We
can leverage the Bayesian abilities to quantify uncertainty and count
how many<br>
emission observations (black points on the plots above) have densities
within the 95% CI of the predicted probability densities (the error bars
on the plots above). We can also quantify how different the observed and
predicted densities are by looking at the Sum of Squared Errors (SSE):
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>E</mi><mo>=</mo><mo>∑</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo>−</mo><mover><msub><mi>y</mi><mi>i</mi></msub><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">SSE=\displaystyle\sum(y_i-\hat{y_i})^2</annotation></semantics></math>.
Lastly, we might want to check if the area under the curve of the
probability distribution is close to 1. If it doesn’t integrate to 1,
than it isn’t a proper probability density. This is the case for the
Normal distribution in our example, since some of it would extend below
0 where emissions are not defined, it integrates to less than 1.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_metrics</span><span class="op">=</span><span class="va">results</span><span class="op">$</span><span class="va">fit_table</span></span></code></pre></div>
<table class="table">
<caption>Goodness of fit results for IIS HCl emissions</caption>
<thead><tr class="header">
<th align="left">Distribution</th>
<th align="right">SSE</th>
<th align="right">No. Obs. in 95% CI</th>
<th align="right">integral</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Gamma</td>
<td align="right">98400</td>
<td align="right">34</td>
<td align="right">0.9870868</td>
</tr>
<tr class="even">
<td align="left">Beta</td>
<td align="right">108000</td>
<td align="right">34</td>
<td align="right">0.9875739</td>
</tr>
<tr class="odd">
<td align="left">Skewed</td>
<td align="right">192000</td>
<td align="right">30</td>
<td align="right">0.9879832</td>
</tr>
<tr class="even">
<td align="left">Lognormal</td>
<td align="right">220000</td>
<td align="right">35</td>
<td align="right">0.9858015</td>
</tr>
<tr class="odd">
<td align="left">Normal</td>
<td align="right">2810000</td>
<td align="right">4</td>
<td align="right">0.5671120</td>
</tr>
</tbody>
</table>
<p>The Gamma and Beta distributions have the lowest SSE, the most
emission observations with densities in the 95% of the probability
density, and both have areas under the curve that integrate to
approximately 1. The Skewed distribution has slightly higher SSE and
fewer observations in the confidence intervals. The Lognormal
distribution has the most observations in the confidence intervals (by
1), but has a larger SSE due to a few points being particularly
off-target. As expected, the Normal distribution scores the worst on all
accounts. The quantitative results provided in
<code>results$fit_table</code> agree with the visual comparison in the
figure above.</p>
<p>We will select the Gamma distribution, because it is both the best
ranked and aligns well in a visual assessment, and because Gamma is
defined from (0, Inf) whereas Beta (which is almost as good) is defined
from (0, 1). Even though all of out observations are well below 1, this
is an unnecessary constraint.</p>
</div>
<div class="section level3">
<h3 id="step-4-upper-predictive-limits-upl-results">Step 4: Upper Predictive Limits (UPL) results<a class="anchor" aria-label="anchor" href="#step-4-upper-predictive-limits-upl-results"></a>
</h3>
<p>Now that we have fit the likelihood distributions we can examine the
UPL results. The default values in <code><a href="../reference/Bayesian_UPL.html">Bayesian_UPL()</a></code> assume a
significance of 0.99 and an average of 3 future runs (as is typical in a
compliance test). The <code>significance</code> and
<code>future_runs</code> arguments can be set to other values if
desired, which will not affect the fitted likelihood distribution but
will change the UPL calculation. The UPL results are the variable
<code>UPL</code> stored in <code>results$fit_table</code>:</p>
<table class="table">
<caption>Upper Predictive Limits for IIS HCl emissions</caption>
<thead><tr class="header">
<th align="left">Distribution</th>
<th align="right">UPL</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Gamma</td>
<td align="right">0.00261</td>
</tr>
<tr class="even">
<td align="left">Beta</td>
<td align="right">0.00260</td>
</tr>
<tr class="odd">
<td align="left">Skewed</td>
<td align="right">0.00246</td>
</tr>
<tr class="even">
<td align="left">Lognormal</td>
<td align="right">0.00342</td>
</tr>
<tr class="odd">
<td align="left">Normal</td>
<td align="right">0.00291</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="step-5-check-for-convergence">Step 5: Check for convergence<a class="anchor" aria-label="anchor" href="#step-5-check-for-convergence"></a>
</h3>
<p>One last step before we can accept the UPL result is to check for
convergence. Given how well the Gamma likelihood fit the probability
distribution, it is highly unlikely that we have any convergence issues.
However, we will need to verify and document the convergence every time.
We will check for convergence both quantitatively and qualitatively.</p>
<p>The quantitative convergence results are stored in
<code>results$conv_output</code>. The parameters for each distribution
supplied to <code><a href="../reference/Bayesian_UPL.html">Bayesian_UPL()</a></code> are monitored and assessed for
convergence using the Gelman-Rubin diagnostic, and the corresponding
outcome for convergence is in <code>convYN</code>. If any distribution’s
parameters fail the Gelman-Rubin diagnostic checks for convergence, then
its results cannot be used.</p>
<table class="table">
<caption>Gelman-Rubin convergence tests for likelihood
parameters</caption>
<thead><tr class="header">
<th align="left">Distribution</th>
<th align="left">Parameter</th>
<th align="right">Diagnostic</th>
<th align="left">Converged</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Beta</td>
<td align="left">alpha_em</td>
<td align="right">1.001</td>
<td align="left">Yes</td>
</tr>
<tr class="even">
<td align="left">Beta</td>
<td align="left">beta_em</td>
<td align="right">1.002</td>
<td align="left">Yes</td>
</tr>
<tr class="odd">
<td align="left">Gamma</td>
<td align="left">rate_em</td>
<td align="right">1.000</td>
<td align="left">Yes</td>
</tr>
<tr class="even">
<td align="left">Gamma</td>
<td align="left">shape_em</td>
<td align="right">1.000</td>
<td align="left">Yes</td>
</tr>
<tr class="odd">
<td align="left">Lognormal</td>
<td align="left">u_ln</td>
<td align="right">1.000</td>
<td align="left">Yes</td>
</tr>
<tr class="even">
<td align="left">Lognormal</td>
<td align="left">sd_ln</td>
<td align="right">1.000</td>
<td align="left">Yes</td>
</tr>
<tr class="odd">
<td align="left">Normal</td>
<td align="left">emission_mean</td>
<td align="right">1.000</td>
<td align="left">Yes</td>
</tr>
<tr class="even">
<td align="left">Normal</td>
<td align="left">emission_sd</td>
<td align="right">1.000</td>
<td align="left">Yes</td>
</tr>
<tr class="odd">
<td align="left">Skewed</td>
<td align="left">omega</td>
<td align="right">1.000</td>
<td align="left">Yes</td>
</tr>
<tr class="even">
<td align="left">Skewed</td>
<td align="left">xi</td>
<td align="right">1.001</td>
<td align="left">Yes</td>
</tr>
<tr class="odd">
<td align="left">Skewed</td>
<td align="left">alpha</td>
<td align="right">1.000</td>
<td align="left">Yes</td>
</tr>
</tbody>
</table>
<p>The Gelman-Rubin diagnostic will test if the 3 separate MCMC chains
have become well-mixed and without trends. Passing the Gelman-Rubin
convergence test is necessary but not sufficient. A visual examination
of the MCMC iterations and parameter histograms is also necessary. A
well converged visual assessment will show evenly mixed iterations
across all chains and an approximately normal histogram for the
parameter’s posterior distribution. A report with the figures needed to
assess convergence can be generated by <code><a href="../reference/Bayesian_UPL.html">Bayesian_UPL()</a></code> by
setting the argument <code>convergence_report = TRUE</code>. This report
will be saved in your active working directory as
“Bayesian_UPL_convergence_current-date-and-time.pdf”</p>
<pre><code><span><span class="co">#&gt; Compiling rjags model...</span></span>
<span><span class="co">#&gt; Starting 3 rjags simulations using a PSOCK cluster with 3 nodes on host</span></span>
<span><span class="co">#&gt; 'localhost'</span></span>
<span><span class="co">#&gt; Simulation complete</span></span>
<span><span class="co">#&gt; Finished running the simulation</span></span>
<span><span class="co">#&gt; [[1]]</span></span></code></pre>
<p><img src="Bayesian-UPL_files/figure-html/figure4-1.png" width="700" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span></code></pre>
<p><img src="Bayesian-UPL_files/figure-html/figure4-2.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="further-options-for-bayesian-upl-analysis">Further options for Bayesian UPL analysis<a class="anchor" aria-label="anchor" href="#further-options-for-bayesian-upl-analysis"></a>
</h2>
<p>In the example above we used the default settings to automatically
control things such as the prior distribution, initial values, expected
emission range, and observation density evaluation. While the default
settings are a great place to start and might be sufficient for most
uses, the sections below explain the mechanics under-the-hood and full
options in <code><a href="../reference/Bayesian_UPL.html">Bayesian_UPL()</a></code>.</p>
<div class="section level3">
<h3 id="density">Density<a class="anchor" aria-label="anchor" href="#density"></a>
</h3>
<p>In order to know the probability density is a good match for our
emissions data, we want to look at the empirical density of the
observations. This is easy to do with
<code><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">ggplot2::geom_density()</a></code>, which uses
<code><a href="https://rdrr.io/r/stats/density.html" class="external-link">stats::density()</a></code> and can take additional arguments related
to how the density is determined such as the bandwidth <code>bw</code>,
kernel <code>kernel</code>, and known upper and lower limits in
<code>bounds</code>. By default, <code>geom_density()</code> uses no
bounds, a gaussian kernel, and a rule-of-thumb method (not recommended)
of arriving at a bandwidth (Silverman B. W. 1986. Density Estimation
p.48 eq 3.31).</p>
<p>In most situations, we will want more control over the density than
<code><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">ggplot2::geom_density()</a></code> provides, and we will want to use
the observation densities outside of the plot later on. For example, all
emissions data will be bounded by 0 and will often have an upper bound
as well. Due to the strictly positive nature of emissions data, a
gaussian kernel is not often a good choice.</p>
<p>Instead we recommend the <code><a href="../reference/obs_density.html">obs_density()</a></code> function in
<code>UPLforOAR</code>, which builds on the
<code><a href="https://rdrr.io/pkg/np/man/npuniden.boundary.html" class="external-link">np::npuniden.boundary()</a></code> function, a more accurate density
function for bounded data. By default, <code><a href="../reference/obs_density.html">obs_density()</a></code> will
assume a lower bound of 0, no upper bound, and the <code>kernel</code>
type is gamma. Other kernel types accepted by
<code><a href="https://rdrr.io/pkg/np/man/npuniden.boundary.html" class="external-link">np::npuniden.boundary()</a></code> can be used, for example if data
are percent removals instead of emissions then “beta1” or “beta2” with
an upper bound of 1 are more appropriate. The default bandwidth
<code>bw</code> is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mo>*</mo><msup><mi>n</mi><mrow><mo>−</mo><mn>2</mn><mi>/</mi><mn>5</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\sigma*n^{-2/5}</annotation></semantics></math>
(Renault &amp; Scaillet 2004), though manual values or a least-squares
or likelihood search can be used instead by setting
<code>bw = "cv.ls"</code> or <code>bw = "cv.ml"</code>.</p>
<p>The results of <code><a href="../reference/obs_density.html">obs_density()</a></code> include
<code>ObsonPoint</code>, with the observation densities paired with each
emission value in the provided data set, and <code>obs_den_df</code>, a
sequence of densities across a range of possible emission values
(<code>xvals</code>) based on the observed emissions. The range of
emissions <code>xvals</code> can be supplied manually, and by default is
<code>seq(0,3*max(data$emissions,length.out=1024))</code>.</p>
<p>Run <code><a href="../reference/obs_density.html">?obs_density</a></code> in the console for detailed information
in the help pages.</p>
</div>
<div class="section level3">
<h3 id="priors">Priors<a class="anchor" aria-label="anchor" href="#priors"></a>
</h3>
<p>Bayesian inference uses prior information to derive posterior
distributions of model parameters. The default behavior in
<code><a href="../reference/Bayesian_UPL.html">Bayesian_UPL()</a></code> is to use uninformative priors which is
calculated based on the range and variance of the emissions data. The
prior information can be manually supplied to either increase the
parameter space to search wider, or to provide more specific
information, which might be particularly useful in circumstances where
there are very few observations (i.e.  <code>n = 3</code>).</p>
</div>
<div class="section level3">
<h3 id="convergence">Convergence<a class="anchor" aria-label="anchor" href="#convergence"></a>
</h3>
<p>Convergence of distribution parameters is assessed quantitatively
using the Gelman-Rubin diagnostic and qualitatively by producing figures
in a convergence report pdf document.</p>
<p>and the corresponding outcome for convergence is in
<code>convYN</code>. This will be a “Yes” for diagnostics less than 1.1,
“weak convergence” for values between 1.1 and 1.2, and “No” convergence
for values greater than 1.2.</p>
<p>It is possible for a parameter to pass the Gelman-Rubin test and
indeed be well-mixed, but not arrive at a clear posterior distribution.
This can happen when there is too little data (for example extremely
small data sets where <code>n = 3</code>), and the parameter posterior
is simply returning the prior distribution. For example, a poorly
converged Normal distribution might have an even probability of the mean
being any emission value, in which case the histogram will be flat
across the entire parameter-space.</p>
<p><em>add example of bad convergence</em></p>
<p>The visual assessment will also catch any issues with the prior
distribution settings. Ideally, we are using uninformative priors for
UPL calculations that have equal probability across a parameter-space
that is much wider than the posterior result. This is determined
automatically from the data, but in some cases that range might not wide
enough. This will be apparent if the parameter’s posterior histogram is
highly skewed towards the end of the allowed range. In this case, the
priors will need to be set manually to a wider uninformative range.</p>
<p><em>add example of bad posterior</em></p>
</div>
<div class="section level3">
<h3 id="long--and-heavy-tailed-distributions">Long- and Heavy-Tailed Distributions<a class="anchor" aria-label="anchor" href="#long--and-heavy-tailed-distributions"></a>
</h3>
<p>For example some Lognormal. The 99^{th} percentile can be
unreasonably large emission number when long or heavy tail. This is
often an issue when the observations themselves are no where near the
tail, and thus the tail is largely unsupported by any data. In such
circumstances, the UPL can be a value larger than any in the observation
data set, or larger than is physically possible. In such cases it is
necessary to truncate the probability distribution to physically
reasonable bounds. This is done by default as 3 times the maximum
emissions value in the training data, but can be adjusted by setting
<code>maxY</code>.</p>
<p><em>show example of two distributions, one long-tailed one not, where
maxY is varied</em></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ludda Ludwig.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
