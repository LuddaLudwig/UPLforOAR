---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  echo = FALSE,
  error=TRUE,
  warning=FALSE,
  message=FALSE
  #results=FALSE
)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(viridis)
library(ggtext)
library(matrixStats)
library(scales)
library(EnvStats)
library(patchwork)
library(grid)
library(np)
library(sfsmisc)
```

# EPA.MACT.floor.UPL

<!-- badges: start -->
<!-- badges: end -->

The goal of EPA.MACT.floor.UPL is to provide a set of functions for handling NESHAP emissions datasets for MACT floor analysis and UPL calculations. These functions include selecting the best and top performing sources from emissions data based on appropriate Clean Air Act sections, determining the appropriate distributions for the emissions data, and calculating the UPL for EG and NSPS standards.

## Installation

You can install the development version of EPA.MACT.floor.UPL from [GitHub](https://github.com/LuddaLudwig/EPA.MACT.floor.UPL) with: 

``` r
# install.packages("pak")
pak::pak("LuddaLudwig/EPA.MACT.floor.UPL")
```

## Example emissions data

This is example uses Hg emissions data from the recent [EPA rule-making](https://www.regulations.gov/document/EPA-HQ-OAR-2009-0234-20132) National Emission Standards for Hazardous Air Pollutants for Coal- and Oil-fired Electric Utility Steam Generating Units. This data set contains a lot of test report information, but only columns for 'emissions' and 'sources' are needed for the MACT floor UPL analysis. The 'emissions' and 'sources' need to be named such explicitly. The emissions should all be in consistent units, and the sources should be unique at the unit-level (e.g. a single boiler), not including sub-categories. 

```{r example, echo=TRUE}
library(EPA.MACT.floor.UPL)
dat_emiss=read_csv("man/data_example/MATS_Hg.csv",col_names=TRUE)
dat_emiss$sources=paste0(dat_emiss$`Plant Name`,"_",dat_emiss$`Unit Number`,"_",dat_emiss$boiler_id)
dat_emiss$emissions=dat_emiss$Mercury_min_lb_MMBtu
dat_emiss=subset(dat_emiss,select=c(sources,emissions))
summary(dat_emiss$emissions)

dat_EG=MACT_EG(CAA_section=112,dat_emiss)
dat_EG_avg=dat_EG%>%group_by(sources)%>%summarize(avg=mean(emissions),
                                                                 counts=n())
dat_EG_avg=arrange(dat_EG_avg,avg)
distribution_result_EG=distribution_type(dat_EG)

```
Since there were more than 30 sources in the emissions data, the top 12% were chosen to represent the top sources. This yielded `nrow(dat_EG)` sources. The data included in this regulatory docket were test averages as opposed to individual runs. As such the number of future runs used in UPL calculations will be `1` instead of the default, an average of `3` runs. The appropriate distribution for the UPL calculation is `distribution_result_EG`.

```{r EG table}
knitr::kable(dat_EG_avg%>%mutate(across(c(2),~signif(.,digits=4)))%>%head(),
             caption="Top sources for existing guidance UPL calculation",
             col.names=c('Source','Average emission','No. of Tests'),digits=12)
```

```{r cars}
summary(cars)
```

You'll still need to render `README.Rmd` regularly, to keep `README.md` up-to-date. `devtools::build_readme()` is handy for this.


